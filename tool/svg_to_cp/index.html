<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SVG to CP Converter (Hex Color Mapping)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      text-align: center;
    }
    input, button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #file-name {
      margin-top: 10px;
      color: #555;
      font-size: 14px;
    }
    .color-inputs {
      margin-top: 20px;
    }
    .color-inputs label {
      display: block;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2>SVG to CP Converter</h2>

  <input type="file" id="svgInput" accept=".svg">
  <div id="file-name">No file selected</div>

  <div class="color-inputs">
    <label>
      mountain (type 2)：
      <input type="text" id="redColor" value="#ff0000">
    </label>
    <label>
      valley (type 3)：
      <input type="text" id="blueColor" value="#0000ff">
    </label>
    <label>
      edge (type 1)：
      <input type="text" id="blackColor" value="#000000">
    </label>
  </div>

  <button onclick="convertSVGtoCP()">Convert and Download .cp</button>

  <script>
    const svgInput = document.getElementById('svgInput');
    const fileNameDisplay = document.getElementById('file-name');

    svgInput.addEventListener('change', () => {
      const file = svgInput.files[0];
      fileNameDisplay.textContent = file ? file.name : "No file selected";
    });

    function formatCoord14(val) {
      return parseFloat(val).toFixed(14);
    }

    function convertSVGtoCP() {
      const file = svgInput.files[0];
      if (!file) {
        alert("Please select an SVG file first.");
        return;
      }

      const redValue = document.getElementById('redColor').value.toLowerCase();
      const blueValue = document.getElementById('blueColor').value.toLowerCase();
      const blackValue = document.getElementById('blackColor').value.toLowerCase();

      const colorToTypeMapping = {
        [redValue]: 2,
        [blueValue]: 3,
        [blackValue]: 1
      };

      const reader = new FileReader();
      reader.onload = function (e) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(e.target.result, "image/svg+xml");
        const lines = doc.getElementsByTagName('line');

        if (lines.length === 0) {
          alert("No <line> elements found in the SVG.");
          return;
        }

        let cpLines = [];

        for (let line of lines) {
          const x1 = line.getAttribute('x1');
          const y1 = line.getAttribute('y1');
          const x2 = line.getAttribute('x2');
          const y2 = line.getAttribute('y2');
          const stroke = (line.getAttribute('stroke') || '').toLowerCase();

          const type = colorToTypeMapping[stroke] || 1; 

          cpLines.push(`${type} ${formatCoord14(x1)} ${formatCoord14(y1)} ${formatCoord14(x2)} ${formatCoord14(y2)}`);
        }

        const blob = new Blob([cpLines.join('\n')], { type: "text/plain" });
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = file.name.replace(/\.svg$/, '') + ".cp";
        downloadLink.click();
        alert("Conversion complete. CP file downloaded.");
      };

      reader.readAsText(file);
    }
  </script>
</body>
</html>
