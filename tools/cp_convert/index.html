<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CP 转图片</title>
  <link rel="icon" href="../../res/ico.png">
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #f0f0f0;
      color: #333;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background-color: #222;
      color: #fff;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0 auto;
      font-size: 1.5rem;
    }
    header a {
      color: #fff;
      text-decoration: none;
      background-color: #444;
      padding: 0.4rem 0.8rem;
      border-radius: 5px;
      transition: background-color 0.2s;
    }
    header a:hover {
      background-color: #666;
    }
    main {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button, label[for="fileInput"] {
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background-color: #333;
      color: white;
      cursor: pointer;
      margin: 0.5rem;
      transition: background-color 0.2s;
    }
    button:hover, label[for="fileInput"]:hover {
      background-color: #555;
    }
    #fileName {
      margin-top: 1rem;
      font-size: 0.95rem;
      color: #555;
    }
    svg {
      max-width: 100%;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <a href="../../index.html">← 返回主页</a>
    <h1>CP 转图片</h1>
    <div style="width:80px;"></div>
  </header>

  <main>
    <input type="file" id="fileInput" accept=".cp" style="display:none;">
    <label for="fileInput">选择 CP 文件</label>
    <div id="fileName"></div>

    <div id="buttonContainer" style="display:none;">
      <button id="saveButton">导出 SVG</button>
      <button id="savePngButton">导出 PNG</button>
      <button id="saveJpgButton">导出 JPG</button>
    </div>

    <div id="previewContainer" style="display:none;"></div>
  </main>

  <script>
    let currentFileName = "";

    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        currentFileName = file.name.replace(/\.[^/.]+$/, "");
        document.getElementById('fileName').textContent = `已选择: ${file.name}`;
        document.getElementById('buttonContainer').style.display = 'block';
        const reader = new FileReader();
        reader.onload = function (e) {
          const lines = e.target.result.split('\n');
          let svgContent = `<svg id="svgPreview" xmlns="http://www.w3.org/2000/svg">`;
          let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
          lines.forEach(line => {
            if (line.trim()) {
              const parts = line.trim().split(/\s+/);
              if (parts.length === 5) {
                const type = parseInt(parts[0]);
                const [x1,y1,x2,y2] = parts.slice(1).map(parseFloat);
                minX = Math.min(minX,x1,x2); minY = Math.min(minY,y1,y2);
                maxX = Math.max(maxX,x1,x2); maxY = Math.max(maxY,y1,y2);
                let color = "#000";
                if (type===2) color="#f00";
                else if (type===3) color="#00f";
                else if (type===4) color="#64C8C8";
                svgContent += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="1"/>`;
              }
            }
          });
          svgContent += "</svg>";
          const container=document.getElementById("previewContainer");
          container.innerHTML=svgContent;
          container.style.display="block";
          const svgEl=document.getElementById("svgPreview");
          if(minX!==Infinity){
            svgEl.setAttribute("viewBox",`${minX} ${minY} ${maxX-minX} ${maxY-minY}`);
          }
        };
        reader.readAsText(file);
      }
    });

    // 通用文件下载
    function downloadFile(data, filename, type) {
      const blob = new Blob([data], {type});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // 导出 SVG
    document.getElementById('saveButton').onclick=()=>{
      const svgEl=document.getElementById('svgPreview');
      if(svgEl){
        const data=new XMLSerializer().serializeToString(svgEl);
        downloadFile(data, currentFileName+".svg", "image/svg+xml");
      }
    };

    // 导出 PNG / JPG (短边1080，长边等比例)
    function exportRaster(format) {
      const svgEl = document.getElementById('svgPreview');
      if (!svgEl) return;

      const svgData = new XMLSerializer().serializeToString(svgEl);
      const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.onload = function () {
        let width = img.width;
        let height = img.height;

        const scale = 1080 / Math.min(width, height);
        width = Math.round(width * scale);
        height = Math.round(height * scale);

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        let mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
        let dataURL = canvas.toDataURL(mimeType, 0.92);

        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `${currentFileName}.${format}`;
        link.click();

        URL.revokeObjectURL(url);
      };
      img.src = url;
    }

    document.getElementById('savePngButton').onclick = () => exportRaster('png');
    document.getElementById('saveJpgButton').onclick = () => exportRaster('jpg');
  </script>
</body>
</html>
