<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG 转 CP</title>
  <link rel="icon" href="../../res/ico.png">
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #f0f0f0;
      color: #333;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background-color: #222;
      color: #fff;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { margin:0 auto; font-size:1.5rem; }
    header a {
      color: #fff;
      text-decoration: none;
      background-color: #444;
      padding: 0.4rem 0.8rem;
      border-radius: 5px;
      transition: background-color 0.2s;
    }
    header a:hover { background-color:#666; }
    main {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input[type="file"], button {
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background-color: #333;
      color: white;
      cursor: pointer;
      margin: 0.5rem;
      transition: background-color 0.2s;
    }
    input[type="text"] {
      margin:0.3rem;
      padding:0.4rem;
    }
    button:hover { background-color:#555; }
    #file-name { margin-top: 1rem; font-size:0.95rem; color:#555; }
    .color-inputs { margin-top: 1rem; }
    .color-inputs label { display:block; margin:0.3rem; }
  </style>
</head>
<body>
  <header>
    <a href="../../index.html">← 返回主页</a>
    <h1>SVG 转 CP</h1>
    <div style="width:80px;"></div>
  </header>

  <main>
    <input type="file" id="svgInput" accept=".svg">
    <div id="file-name">未选择文件</div>

    <div class="color-inputs">
      <label>山折线 (type 2)：<input type="text" id="redColor" value="#ff0000"></label>
      <label>谷折线 (type 3)：<input type="text" id="blueColor" value="#0000ff"></label>
      <label>边缘线 (type 1)：<input type="text" id="blackColor" value="#000000"></label>
      <label>辅助线 (type 4)：<input type="text" id="cyanColor" value="#64c8c8"></label>
    </div>

    <button onclick="convertSVGtoCP()">转换并下载 .cp</button>
  </main>

  <script>
    const svgInput=document.getElementById('svgInput');
    const fileNameDisplay=document.getElementById('file-name');
    svgInput.addEventListener('change',()=>{const f=svgInput.files[0]; fileNameDisplay.textContent=f?f.name:"未选择文件";});

    function normalizeColor(color) {
      const ctx=document.createElement("canvas").getContext("2d");
      ctx.fillStyle=color;
      return ctx.fillStyle.toLowerCase(); // 返回标准化 hex 颜色
    }

    function formatCoord(val){
      return parseFloat(val).toFixed(14); // 保持高精度
    }

    function convertSVGtoCP(){
      const file=svgInput.files[0];
      if(!file){alert("请先选择一个 SVG 文件"); return;}

      const mapping = {
        [normalizeColor(document.getElementById('redColor').value)]: 2,
        [normalizeColor(document.getElementById('blueColor').value)]: 3,
        [normalizeColor(document.getElementById('blackColor').value)]: 1,
        [normalizeColor(document.getElementById('cyanColor').value)]: 4
      };

      const reader=new FileReader();
      reader.onload=function(e){
        const doc=new DOMParser().parseFromString(e.target.result,"image/svg+xml");
        const lines=doc.getElementsByTagName('line');
        if(!lines.length){alert("SVG 中没有 <line> 元素"); return;}
        let cpLines=[];
        for(let line of lines){
          const x1=line.getAttribute("x1");
          const y1=line.getAttribute("y1");
          const x2=line.getAttribute("x2");
          const y2=line.getAttribute("y2");
          const stroke=normalizeColor(line.getAttribute("stroke")||"#000");
          const type=mapping[stroke]||1;
          cpLines.push(`${type} ${formatCoord(x1)} ${formatCoord(y1)} ${formatCoord(x2)} ${formatCoord(y2)}`);
        }
        const blob=new Blob([cpLines.join("\n")],{type:"text/plain"});
        const link=document.createElement("a");
        link.href=URL.createObjectURL(blob);
        link.download=file.name.replace(/\.svg$/,"")+".cp";
        link.click();
        alert("转换完成，已下载 CP 文件。");
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
